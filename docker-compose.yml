# Définition de la version de Docker Compose
version: '3.8'

services:
  # =======================================================================
    # RÔLE DE CE CONTENEUR :
    # Ce conteneur ('db') est le serveur de base de données PostgreSQL.
    # Son unique rôle est de stocker les données de configuration (Guacamole et Keycloak).
  
    # CONNEXIONS AVEC D'AUTRES SERVICES :
    # Ce service n'initie aucune connexion. Il attend les connexions entrantes.
    #
    # - 'guacamole-webapp' (Connexion entrante) :
    #   'guacamole-webapp' se connecte à ce conteneur pour lire et écrire la
    #   liste des connexions RDP et leurs permissions (dans la BD 'guacamole_db').
    #
    # - 'keycloak' (Connexion entrante) :
    #   'keycloak' se connecte aussi à ce conteneur (avec le même utilisateur).
    #   Keycloak va automatiquement créer et gérer sa PROPRE base de
    #   données (ex: 'keycloak_db') à l'intérieur de ce service pour
    #   stocker ses realms, clients, etc.
    # =======================================================================
  db:
    image: postgres:15
    container_name: db_postgres
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - services-net
    environment:
      POSTGRES_USER: guacamole_user
      POSTGRES_PASSWORD: password 
      POSTGRES_DB: guacamole_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U guacamole_user -d guacamole_db"]
      interval: 5s
      timeout: 5s
      retries: 5

# --- 2. LE SERVICE D'ANNUAIRE ---
    # =======================================================================
    # RÔLE DE CE CONTENEUR :
    # Ce conteneur ('ldap') est le serveur d'annuaire OpenLDAP.
    # Son unique rôle est de stocker et de gérer les informations d'identité :
    # les utilisateurs (ex: 'etudiant1'), les mots de passe, et les groupes
    # (ex: 'groupFiliereA'). C'est la "source de vérité" pour qui est qui.
    #
    # CONNEXIONS AVEC D'AUTRES SERVICES :
    # Ce service attend
  ldap:
    image: osixia/openldap:1.5.0
    container_name: openldap
    volumes:
      # Volume de l'annuaire (utilisateurs, groupes)
      - ldap-data:/var/lib/ldap
      # RColume pour la configuration d'OpenLDAP 
      - ldap-config:/etc/ldap/slapd.d
    networks:
      - services-net
    environment:
      # Définit le domaine de base pour votre annuaire.
      # 'dc=ensate,dc=local' sera votre "Base DN"
      LDAP_DOMAIN: ensate.local # ??? 
      # Définit le mot de passe pour l'administrateur LDAP (ex: cn=admin,dc=ensate,dc=local)
      LDAP_ADMIN_PASSWORD: password
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-b", "dc=ensate,dc=local", "-H", "ldap://localhost"]
      interval: 5s
      timeout: 5s
      retries: 5


# --- 3. LE SERVICE D'AUTHENTIFICATION ---
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    ports:
      # Expose le port 8080 de Keycloak sur le port 8080 de la VM hôte
      # C'est ici que vous accéderez à la console d'admin et à la page de login
      - "8080:8080"
    networks:
      - services-net
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: password 

      # --- Connexion à la Base de Données (PostgreSQL) ---
      # Dit à Keycloak d'utiliser 'postgres'
      KC_DB: postgres
      # Le nom du service 'db' sur le réseau docker-compose
      KC_DB_URL_HOST: db
      # Le nom de la base de données que Keycloak va créer et utiliser
      KC_DB_DATABASE: keycloak_db
      # L'utilisateur pour se connecter à PostgreSQL
      KC_DB_USERNAME: guacamole_user
      # Le mot de passe pour cet utilisateur (doit correspondre à celui du service 'db')
      KC_DB_PASSWORD: password 
      KC_SCHEMA: public

      # --- Configuration Réseau Cruciale ---
      # L'adresse publique que les navigateurs utiliseront pour joindre Keycloak.
      # C'est VITAL pour OIDC. Remplacez par l'IP de votre VM.
      KC_HOSTNAME: 192.168.100.5:8080 # <--- CHANGEZ CECI (IP:PORT)
      
      # (Optionnel) Permet de démarrer en HTTP pour le développement
      KC_HTTP_ENABLED: 'true'
      KC_PROXY: 'edge'
    depends_on:
      # Dit à Docker d'attendre avant de démarrer Keycloak
      db:
        condition: service_healthy
      ldap:
        condition: service_healthy

    # =======================================================================
    # RÔLE DE CE CONTENEUR :
    # Ce conteneur ('keycloak') est le serveur central d'authentification (IdP).
    # Son rôle est de fournir une page de connexion unique (SSO) pour toutes
    # vos applications (Guacamole, Proxmox). Il gère le protocole OIDC.
    #
    # CONNEXIONS AVEC D'AUTRES SERVICES :
    #
    # - 'db' (Connexion sortante) :
    #   Keycloak se connecte à 'db' pour écrire et lire sa propre configuration
    #   (realms, clients OIDC, secrets, etc.) dans la base 'keycloak_db'.
    #
    # - 'ldap' (Connexion sortante) :
    #   Keycloak se connecte à 'ldap' (via la "User Federation" que vous
    #   configurerez manuellement) pour LIRE les utilisateurs et les groupes,
    #   et pour VÉRIFIER les mots de passe.
    #
    # - 'guacamole-webapp' (Connexion entrante) :
    #   Le service 'guacamole-webapp' n'est pas encore défini, mais il
    #   redirigera les navigateurs des utilisateurs vers ce conteneur
    #   Keycloak pour qu'ils puissent s'authentifier.
    # =======================================================================


# --- 4. LE MOTEUR RDP (Back-end Guacamole) ---

     # =======================================================================
    # RÔLE DE CE CONTENEUR :
    # Ce conteneur ('guacd') est le moteur back-end de Guacamole.
    # Son unique rôle est d'agir comme un traducteur : il parle les protocoles
    # de bureau à distance natifs (RDP, VNC) et les traduit en protocole
    # Guacamole pour le 'guacamole-webapp'. Il est invisible pour l'utilisateur.
    #
    # CONNEXIONS AVEC D'AUTRES SERVICES :
    #
    # - 'guacamole-webapp' (Connexion entrante) :
    #   Le service 'guacamole-webapp' (que nous ajouterons ensuite) se
    #   connectera à 'guacd' (sur le port 4822 interne) pour lui
    #   donner l'ordre de démarrer une session RDP vers une VM cible.
    #
    # - VM "Ressources" (Connexion sortante) :
    #   Ce conteneur initiera des connexions RDP/VNC sortantes vers vos
    #   autres VMs (ex: 'Ressources-FiliereA') sur le réseau de l'école.
    # =======================================================================
  guacd:
    # Utilise l'image officielle de guacd (le daemon Guacamole)
    # Il est crucial d'utiliser la MÊME version que le 'guacamole-webapp'
    image: guacamole/guacd:1.5.3
    container_name: guacd
    networks:
      # Le connecte au réseau partagé 'services-net'
      - services-net
    # Note: Pas de 'ports' exposés au public. Seul 'guacamole-webapp'


 
# Définition des volumes pour la persistance des données
volumes:
  db-data:
  ldap-data:
  ldap-config: